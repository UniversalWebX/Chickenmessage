<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Host Panel</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="win12">
  <div class="window" style="width:900px; max-width:96vw;">
    <div class="titlebar">
      <div class="title">Admin Panel</div>
      <div class="actions"><a href="/logout" class="btn tiny">Logout</a></div>
    </div>

    <div class="content" style="display:flex; gap:12px;">
      <div style="width:320px;">
        <h3>Users</h3>
        <div id="usersList" style="max-height:360px; overflow:auto; background:rgba(255,255,255,0.02); padding:8px; border-radius:8px;"></div>

        <h3 style="margin-top:10px;">Bans</h3>
        <div id="bansList" style="max-height:160px; overflow:auto; background:rgba(255,255,255,0.02); padding:8px; border-radius:8px;"></div>
      </div>

      <div style="flex:1;">
        <h3>Actions</h3>

        <div style="display:flex; gap:8px; align-items:center;">
          <input id="ban-username" placeholder="Username to ban" />
          <input id="ban-duration" placeholder="minutes (optional)" style="width:140px;" />
          <button id="ban-btn">Ban</button>
          <button id="unban-btn">Unban</button>
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <input id="ip-ban" placeholder="IP to ban" />
          <input id="ip-duration" placeholder="minutes (optional)" style="width:140px;" />
          <button id="ipban-btn">IP Ban</button>
          <button id="unipban-btn">Un-IP-Ban</button>
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <input id="grant-username" placeholder="Username to grant admin" />
          <button id="grant-btn">Give Admin</button>
          <button id="remove-btn">Remove Admin</button>
        </div>

        <div style="margin-top:12px;">
          <button id="lock-btn">Lock Site</button>
          <button id="unlock-btn">Unlock Site</button>
        </div>

        <div style="margin-top:12px;">
          <h4>Announcement</h4>
          <input id="announce-content" placeholder="Announcement text" style="width:80%;" />
          <button id="announce-btn">Send Announcement</button>
        </div>

      </div>
    </div>
  </div>

<script>
async function api(path, body){
  const res = await fetch(path, { method: 'POST', headers: {'Content-Type':'application/json'}, body: body?JSON.stringify(body):null });
  return res.json();
}

async function refreshState(){
  const s = await fetch('/api/state');
  const j = await s.json();
  if(!j.ok) return alert('failed');
  const usersList = document.getElementById('usersList');
  usersList.innerHTML = j.users.map(u => `<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)">${u.username} â€” ${u.role||'user'}</div>`).join('');
  const bansList = document.getElementById('bansList');
  const usernameBans = (j.bans.username||[]).map(b=>`User: ${b.name} (by ${b.by}) ${b.expires?('until '+new Date(b.expires).toLocaleString()):''}`);
  const ipBans = (j.bans.ip||[]).map(b=>`IP: ${b.ip} (by ${b.by}) ${b.expires?('until '+new Date(b.expires).toLocaleString()):''}`);
  bansList.innerHTML = usernameBans.concat(ipBans).map(x=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)">${x}</div>`).join('');
}

document.getElementById('ban-btn').onclick = async ()=>{
  const username = document.getElementById('ban-username').value.trim();
  const duration = parseInt(document.getElementById('ban-duration').value) || 0;
  await api('/api/ban', { username, durationMinutes: duration || null });
  refreshState();
};
document.getElementById('unban-btn').onclick = async ()=>{
  const username = document.getElementById('ban-username').value.trim();
  await api('/api/unban', { username });
  refreshState();
};

document.getElementById('ipban-btn').onclick = async ()=>{
  const ip = document.getElementById('ip-ban').value.trim();
  const duration = parseInt(document.getElementById('ip-duration').value) || 0;
  await api('/api/ipban', { ip, durationMinutes: duration || null });
  refreshState();
};
document.getElementById('unipban-btn').onclick = async ()=>{
  const ip = document.getElementById('ip-ban').value.trim();
  await api('/api/unipban', { ip });
  refreshState();
};

document.getElementById('grant-btn').onclick = async ()=>{
  const username = document.getElementById('grant-username').value.trim();
  await api('/api/giveadmin', { username });
  refreshState();
};
document.getElementById('remove-btn').onclick = async ()=>{
  const username = document.getElementById('grant-username').value.trim();
  await api('/api/removeadmin', { username });
  refreshState();
};

document.getElementById('lock-btn').onclick = async ()=>{
  await api('/api/lock');
  refreshState();
};
document.getElementById('unlock-btn').onclick = async ()=>{
  await api('/api/unlock');
  refreshState();
};

document.getElementById('announce-btn').onclick = async ()=>{
  const content = document.getElementById('announce-content').value.trim();
  await api('/api/announce', { content });
  document.getElementById('announce-content').value = "";
  refreshState();
};

refreshState();
</script>
</body>
</html>
