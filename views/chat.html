<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>ChickenMessenger â€” Chat</title>
<link rel="stylesheet" href="/styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="window">
    <div class="titlebar">
      <div class="title">ChickenMessenger</div>
      <div><a href="/logout" class="btn btn-logout">Logout</a></div>
    </div>
    <div class="content">
      <div class="sidebar" id="sidebar">
        <button id="globalBtn" class="tab active" data-type="global" data-to="">Global</button>
        <div id="dm-tabs"></div>
        <div id="group-tabs"></div>
        <div style="margin-top:8px;">
          <input id="new-group" placeholder="Create group: user1,user2..." />
          <button id="create-group" class="btn">Create Group</button>
        </div>
        <div id="announcement-area" style="margin-top:10px; display:none;">
          <input id="announcement-input" placeholder="Announcement..." />
          <button id="send-announcement" class="btn">Send Announcement</button>
        </div>
      </div>
      <div class="chat-area">
        <div id="messages" class="messages"></div>
        <div class="input-row">
          <input id="input" placeholder="Type a message..." />
          <button id="send" class="btn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- toast container -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- Admin overlay -->
  <div id="adminOverlay" class="admin-overlay" tabindex="0">
    <h3 style="margin-top:0;">Admin Panel</h3>
    <div class="row">
      <input id="kickUser" placeholder="Kick user..." />
      <button class="btn" id="btnKick">Kick</button>
    </div>
    <div class="row">
      <input id="banTarget" placeholder="Ban username..." />
      <input id="banMin" placeholder="mins (optional)" style="width:100px;" />
    </div>
    <div class="row">
      <button class="btn" id="btnBan">Ban</button>
      <button class="btn" id="btnUnban">Unban</button>
    </div>
    <div class="row">
      <input id="ipField" placeholder="IP to ban/unban" />
      <input id="ipMin" placeholder="mins (optional)" style="width:100px;" />
    </div>
    <div class="row">
      <button class="btn" id="ipBanBtn">IP Ban</button>
      <button class="btn" id="ipUnbanBtn">IP Unban</button>
    </div>
    <div class="row">
      <input id="grantUser" placeholder="Username for admin" />
      <button class="btn" id="grantBtn">Give Admin</button>
      <button class="btn" id="removeBtn">Remove Admin</button>
    </div>
    <div class="row">
      <button class="btn" id="btnClear">Clear Global</button>
      <button class="btn" id="btnLock">Lock Site</button>
      <button class="btn" id="btnUnlock">Unlock Site</button>
    </div>
    <div style="margin-top:8px;">
      <input id="announceText" placeholder="Announcement..." />
      <button id="announceSend" class="btn">Send</button>
    </div>
    <div style="margin-top:8px;"><small style="opacity:0.7">Press <kbd>\</kbd> to toggle. Drag to move.</small></div>
  </div>

<script>
(async () => {
  const meRes = await fetch('/me');
  const me = await meRes.json();
  if (!me.ok) return window.location = '/';
  const username = me.username;
  const role = me.role || 'user';

  if (role === 'host' || role === 'admin') document.getElementById('announcement-area').style.display = 'block';

  const socket = io();
  socket.emit('register', username);

  const messagesEl = document.getElementById('messages');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const dmTabs = document.getElementById('dm-tabs');
  const groupTabs = document.getElementById('group-tabs');
  const toastWrap = document.getElementById('toastWrap');

  let currentTab = { type: 'global', to: '' };

  function esc(s) { return (s || '').replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  function addTab(type, to, label) {
    const container = (type === 'dm') ? dmTabs : groupTabs;
    if (container.querySelector(`.tab[data-type="${type}"][data-to="${to}"]`)) return;
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.dataset.type = type;
    btn.dataset.to = to;
    btn.textContent = label;
    btn.onclick = () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      document.querySelector('#globalBtn').classList.remove('active');
      btn.classList.add('active');
      currentTab = { type, to };
      messagesEl.innerHTML = '';
      if (type === 'global') socket.emit('requestGlobal');
      else if (type === 'dm' || type === 'group') {
        // server already pushed history; client renders message events when they arrive
      }
    };
    container.appendChild(btn);
  }

  // Ensure Global is clickable and functions like other tabs
  document.getElementById('globalBtn').onclick = () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.getElementById('globalBtn').classList.add('active');
    currentTab = { type: 'global', to: '' };
    messagesEl.innerHTML = '';
    socket.emit('requestGlobal');
  };

  function renderMessage(m) {
    if (m.type === 'global') {
      if (currentTab.type !== 'global') return;
    } else if (m.type === 'dm') {
      const other = (m.username === username) ? m.to : m.username;
      if (!(currentTab.type === 'dm' && currentTab.to === other)) return;
    } else if (m.type === 'group') {
      const id = Array.isArray(m.to) ? m.to.join(',') : m.to;
      if (!(currentTab.type === 'group' && currentTab.to === id)) return;
    }

    const el = document.createElement('div');
    el.className = 'msg' + (m.type === 'announcement' ? ' announcement' : '');
    let meta = `<div class="meta"><strong>${esc(m.username)}</strong>`;
    if (m.type === 'dm') meta += ` <span>(DM ${m.username === username ? 'to ' + esc(m.to) : 'from ' + esc(m.username)})</span>`;
    if (m.type === 'group') meta += ` <span>(Group: ${esc((m.to || []).join(','))})</span>`;
    meta += ` <span style="float:right;opacity:.6;font-size:12px">${new Date(m.time).toLocaleString()}</span></div>`;
    el.innerHTML = `${meta}<div class="text">${esc(m.content || m.text || '')}</div>`;
    messagesEl.appendChild(el);

    const isAtBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 50;
    if (isAtBottom) messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  socket.on('history', msgs => {
    msgs.forEach(m => {
      if (m.type === 'dm') addTab('dm', m.username === username ? m.to : m.username, m.username === username ? m.to : m.username);
      if (m.type === 'group') addTab('group', Array.isArray(m.to) ? m.to.join(',') : m.to, Array.isArray(m.to) ? m.to.join(',') : m.to);
    });
    msgs.forEach(renderMessage);
  });

  socket.on('message', m => {
    if (m.type === 'dm') addTab('dm', m.username === username ? m.to : m.username, m.username === username ? m.to : m.username);
    if (m.type === 'group') addTab('group', Array.isArray(m.to) ? m.to.join(',') : m.to, Array.isArray(m.to) ? m.to.join(',') : m.to);
    renderMessage(m);
  });

  socket.on('globalHistory', msgs => {
    messagesEl.innerHTML = '';
    msgs.forEach(renderMessage);
  });

  socket.on('clearGlobal', () => {
    if (currentTab.type === 'global') messagesEl.innerHTML = '';
    showToast('Global chat cleared.');
  });

  // Announcements -> toasts (top-right stacking)
  socket.on('announcement', data => showToast(data.content));

  function showToast(msg) {
    const wrap = document.getElementById('toastWrap');
    const box = document.createElement('div');
    box.className = 'toast';
    box.textContent = msg;
    wrap.appendChild(box);
    setTimeout(() => box.style.opacity = '0', 5000);
    setTimeout(() => box.remove(), 5600);
  }

  // send messages
  sendBtn.onclick = () => {
    const text = input.value.trim();
    if (!text) return;
    const payload = { type: currentTab.type, content: text };
    if (currentTab.type === 'dm') payload.to = currentTab.to;
    if (currentTab.type === 'group') payload.to = currentTab.to.split(',').map(u => u.trim()).filter(Boolean);
    socket.emit('send', payload);
    input.value = '';
  };

  // create group
  document.getElementById('create-group').onclick = () => {
    const s = document.getElementById('new-group').value.trim();
    if (!s) return;
    const arr = s.split(',').map(x => x.trim()).filter(Boolean);
    if (!arr.includes(username)) arr.push(username);
    const id = arr.join(',');
    addTab('group', id, id);
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    const btn = document.querySelector(`.tab[data-type="group"][data-to="${id}"]`);
    if (btn) btn.classList.add('active');
    currentTab = { type: 'group', to: id };
    messagesEl.innerHTML = '';
    document.getElementById('new-group').value = '';
  };

  // announcement input (admin/host)
  document.getElementById('send-announcement').onclick = async () => {
    const t = document.getElementById('announcement-input').value.trim();
    if (!t) return;
    await fetch('/api/announce', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: t }) });
    document.getElementById('announcement-input').value = '';
  };

  // ---------------- Admin overlay (drag + toggle) ----------------
  const overlay = document.getElementById('adminOverlay');
  const isHostLike = (role === 'host' || role === 'admin');
  if (!isHostLike) overlay.style.display = 'none';

  function toggleOverlay() { overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none'; overlay.focus(); }
  document.addEventListener('keydown', (e) => { if (e.key === '\\' || e.key === '\\\\') toggleOverlay(); });

  // draggable
  let dragging = false, offsetX = 0, offsetY = 0;
  overlay.addEventListener('mousedown', (e) => {
    if (e.target.tagName.toLowerCase() === 'input' || e.target.tagName.toLowerCase() === 'button') return;
    dragging = true;
    const rect = overlay.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    overlay.style.transition = 'none';
  });
  document.addEventListener('mouseup', () => dragging = false);
  document.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    overlay.style.left = (e.clientX - offsetX) + 'px';
    overlay.style.top = (e.clientY - offsetY) + 'px';
    overlay.style.position = 'fixed';
  });

  // admin actions (HTTP)
  const post = async (url, body) => fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }).then(r => r.json());

  document.getElementById('btnKick').onclick = async () => {
    const u = document.getElementById('kickUser').value.trim();
    if (!u) return alert('Type username to kick.');
    // ask server to kick via API which emits serverKick
    await post('/api/kick', { user: u }).catch(() => {});
    // also request server-side socket kick (server listens for serverKick/ serverKickRequest)
    socket.emit('serverKickRequest', { user: u });
    alert('Kick request sent.');
  };

  document.getElementById('btnClear').onclick = async () => {
    socket.emit('adminClearGlobal');
  };

  document.getElementById('btnBan').onclick = async () => {
    const u = document.getElementById('banTarget').value.trim();
    const mins = parseInt(document.getElementById('banMin').value) || null;
    if (!u) return alert('Username required');
    await post('/api/ban', { username: u, durationMinutes: mins });
    alert('Banned (if exists).');
  };
  document.getElementById('btnUnban').onclick = async () => {
    const u = document.getElementById('banTarget').value.trim();
    if (!u) return alert('Username required');
    await post('/api/unban', { username: u });
    alert('Unbanned.');
  };

  document.getElementById('ipBanBtn').onclick = async () => {
    const ip = document.getElementById('ipField').value.trim();
    const mins = parseInt(document.getElementById('ipMin').value) || null;
    if (!ip) return alert('IP required');
    await post('/api/ipban', { ip, durationMinutes: mins });
    alert('IP banned.');
  };
  document.getElementById('ipUnbanBtn').onclick = async () => {
    const ip = document.getElementById('ipField').value.trim();
    if (!ip) return alert('IP required');
    await post('/api/unipban', { ip });
    alert('IP unbanned.');
  };

  document.getElementById('grantBtn').onclick = async () => {
    const u = document.getElementById('grantUser').value.trim();
    if (!u) return alert('Username required');
    await post('/api/giveadmin', { username: u });
    alert('Given admin.');
  };
  document.getElementById('removeBtn').onclick = async () => {
    const u = document.getElementById('grantUser').value.trim();
    if (!u) return alert('Username required');
    await post('/api/removeadmin', { username: u });
    alert('Removed admin.');
  };

  document.getElementById('btnLock').onclick = async () => { await post('/api/lock', {}); alert('Site locked.'); };
  document.getElementById('btnUnlock').onclick = async () => { await post('/api/unlock', {}); alert('Site unlocked.'); };

  document.getElementById('announceSend').onclick = async () => {
    const t = document.getElementById('announceText').value.trim();
    if (!t) return alert('Type announcement');
    await post('/api/announce', { content: t });
    document.getElementById('announceText').value = '';
    alert('Announcement sent.');
  };

})();
</script>
</body>
</html>
